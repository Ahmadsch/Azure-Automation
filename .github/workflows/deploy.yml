name: deploy-aca

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  LOCATION: westeurope
  RG: rg-spring-aca
  ACR: myspringacaacr12345
  ENV_NAME: aca-env
  APP_NAME: spring-aca
  IMAGE_REPO: spring-aca

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Register provider
        run: az provider register --namespace Microsoft.App

      - name: Create resource group (Bicep)
        run: |
          az deployment sub create \
            -l $LOCATION \
            -f infra/00-rg.bicep \
            -p rgName=$RG location=$LOCATION

      - name: Create ACR + ACA environment (Bicep)
        run: |
          az deployment group create \
            -g $RG \
            -f infra/01-infra.bicep \
            -p location=$LOCATION acrName=$ACR envName=$ENV_NAME

      - name: Build and push image to ACR
        run: |
          SERVER=$(az acr show -n $ACR -g $RG --query loginServer -o tsv)
          USER=$(az acr credential show -n $ACR -g $RG --query username -o tsv)
          PASS=$(az acr credential show -n $ACR -g $RG --query "passwords[0].value" -o tsv)

          echo "$PASS" | docker login "$SERVER" -u "$USER" --password-stdin

          TAG=${GITHUB_SHA::7}
          IMAGE="$SERVER/$IMAGE_REPO:$TAG"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

          echo "SERVER=$SERVER" >> $GITHUB_ENV
          echo "USER=$USER" >> $GITHUB_ENV
          echo "PASS=$PASS" >> $GITHUB_ENV
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Container App (Bicep)
        run: |
          az deployment group create \
            -g $RG \
            -f infra/02-app.bicep \
            -p location=$LOCATION \
               appName=$APP_NAME \
               envName=$ENV_NAME \
               image=$IMAGE \
               acrServer=$SERVER \
               acrUsername=$USER \
               acrPassword="$PASS"

      - name: Print URL
        run: |
          FQDN=$(az containerapp show -n $APP_NAME -g $RG --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "APP_URL=https://$FQDN"
